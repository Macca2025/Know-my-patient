{# =============================
    Patient Dashboard Cards
    ============================= #}

<div class="dashboard-card-modern card-success">
    <div class="card-body">
        <div class="card-icon">
            <i class="bi bi-plus-circle text-success"></i>
        </div>
        <h5 class="card-title">Add To My Passport</h5>
        <p class="card-text">Add or update your digital hospital passport details here.</p>
        <div class="card-actions">
            <a href="{{ url_for('add_patient') }}" class="btn btn-outline-success">
                <i class="bi bi-plus me-2"></i>Add Information
            </a>
        </div>
        <div class="card-footer-info">
            <small><i class="bi bi-plus-circle"></i>Digital Hospital Passport</small>
        </div>
    </div>
</div>


{# Share My Records Card #}
<div class="dashboard-card-modern card-success">
    <div class="card-body">
        <div class="card-icon">
            <i class="bi bi-qr-code text-success"></i>
        </div>
        <h5 class="card-title">Share My Records</h5>
        <p class="card-text">Share your Digital Hospital Passport securely here.</p>
        <div class="card-actions">
            <a href="{{ url_for('display_page') }}" class="btn btn-outline-success">
                <i class="bi bi-share me-2"></i>Share Now
            </a>
        </div>
       <div class="card-footer-info">
            <small><i class="bi bi-qr-code"></i>Share Access</small>
        </div>
    </div>
</div>

{# Physical Patient Card #}
<div class="dashboard-card-modern card-warning {% if pendingCardRequest %}card-wide{% endif %}">
    <div class="card-body">
        <div class="card-icon">
            <i class="bi bi-credit-card-2-front text-warning"></i>
        </div>
        <h5 class="card-title">Physical Patient Card</h5>
        
        {% if pendingCardRequest %}
            <!-- Show detailed status if request exists -->
            <p class="card-text mb-1" style="font-size: 0.9rem;">Your card request is being processed.</p>
            
            <div class="card bg-light mb-1">
                <div class="card-body py-1 px-2">
                    <div class="row g-1" style="font-size: 0.85rem;">
                        <div class="col-12">
                            <strong>Status:</strong>
                            {% if pendingCardRequest.status == 'pending' %}
                                <span class="badge bg-secondary ms-1" style="font-size: 0.75rem;">
                                    <i class="bi bi-hourglass-split me-1"></i>Pending Review
                                </span>
                            {% elseif pendingCardRequest.status == 'approved' %}
                                <span class="badge bg-info ms-1" style="font-size: 0.75rem;">
                                    <i class="bi bi-check-circle me-1"></i>Approved
                                </span>
                            {% elseif pendingCardRequest.status == 'printing' %}
                                <span class="badge bg-primary ms-1" style="font-size: 0.75rem;">
                                    <i class="bi bi-printer me-1"></i>Printing
                                </span>
                            {% elseif pendingCardRequest.status == 'quality_check' %}
                                <span class="badge bg-info ms-1" style="font-size: 0.75rem;">
                                    <i class="bi bi-search me-1"></i>Quality Check
                                </span>
                            {% elseif pendingCardRequest.status == 'posted' %}
                                <span class="badge bg-success ms-1" style="font-size: 0.75rem;">
                                    <i class="bi bi-truck me-1"></i>Posted
                                </span>
                            {% elseif pendingCardRequest.status == 'delivered' %}
                                <span class="badge bg-success ms-1" style="font-size: 0.75rem;">
                                    <i class="bi bi-check-all me-1"></i>Delivered
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if pendingCardRequest.tracking_number %}
                        <div class="col-12 mt-1">
                            <strong>Tracking:</strong> 
                            <span class="badge bg-dark">{{ pendingCardRequest.tracking_number }}</span>
                        </div>
                        {% endif %}
                        
                        {% if pendingCardRequest.estimated_delivery %}
                        <div class="col-12">
                            <strong>Est. Delivery:</strong> {{ pendingCardRequest.estimated_delivery|date('M j, Y') }}
                        </div>
                        {% endif %}
                        
                        {% if pendingCardRequest.admin_notes %}
                        <div class="col-12">
                            <div class="alert alert-info mb-0 mt-1 py-1 px-2">
                                <small><strong>Note:</strong> {{ pendingCardRequest.admin_notes }}</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Progress timeline -->
            <div class="mb-1">
                <small class="text-muted d-block mb-1" style="font-size: 0.8rem;"><strong>Progress:</strong></small>
                <div class="progress" style="height: 18px;">
                    {% set progress = 0 %}
                    {% if pendingCardRequest.status == 'pending' %}
                        {% set progress = 20 %}
                    {% elseif pendingCardRequest.status == 'approved' %}
                        {% set progress = 40 %}
                    {% elseif pendingCardRequest.status == 'printing' %}
                        {% set progress = 60 %}
                    {% elseif pendingCardRequest.status == 'quality_check' %}
                        {% set progress = 75 %}
                    {% elseif pendingCardRequest.status == 'posted' %}
                        {% set progress = 90 %}
                    {% elseif pendingCardRequest.status == 'delivered' %}
                        {% set progress = 100 %}
                    {% endif %}
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%;" 
                         aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                        {{ progress }}%
                    </div>
                </div>
            </div>
            
            <div class="card-actions">
                <button class="btn btn-secondary disabled w-100">
                    <i class="bi bi-hourglass-split me-2"></i>Request in Progress
                </button>
            </div>
        {% else %}
            <!-- Show order button if no pending request -->
            <p class="card-text">Order a physical membership card with your unique QR code.</p>
            <div class="card-actions">
                {# If user has a valid patient profile with address/postcode allow direct submission #}
                {% if canRequestCard is defined and canRequestCard %}
                <form method="POST" action="/dashboard/request-card" class="full-width-form" id="cardRequestForm">
                    <input type="hidden" name="{{ csrf.keys.name }}" value="{{ csrf.name }}">
                    <input type="hidden" name="{{ csrf.keys.value }}" value="{{ csrf.value }}">
                    <button type="submit" class="btn btn-outline-warning w-100" id="requestCardBtn">
                        <i class="bi bi-credit-card me-2"></i>Order My Card
                    </button>
                </form>
                {% else %}
                <a href="/add-patient" class="btn btn-outline-warning w-100" id="requestCardBtn">
                    <i class="bi bi-credit-card me-2"></i>Complete Profile to Order Card
                </a>
                {% endif %}
            </div>
            {# Confirmation modal for ordering a card - Bootstrap 5 #}
            <div class="modal fade" id="confirmCardModal" tabindex="-1" aria-labelledby="confirmCardModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="confirmCardModalLabel">Confirm Card Order</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to order a physical patient card? This will use the delivery address on your profile.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" id="confirmCardOrderBtn">Yes, order my card</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var form = document.getElementById('cardRequestForm');
                    var confirmModalEl = document.getElementById('confirmCardModal');
                    if (!form || !confirmModalEl) return;

                    // Use Bootstrap's Modal API
                    var confirmModal = null;
                    try {
                        confirmModal = new bootstrap.Modal(confirmModalEl);
                    } catch (e) {
                        // If bootstrap not available, fall back to native confirm
                        form.addEventListener('submit', function (ev) {
                            if (!confirm('Are you sure you want to order a patient card?')) {
                                ev.preventDefault();
                            }
                        });
                        return;
                    }

                    // Intercept the form submit and show modal
                    form.addEventListener('submit', function (ev) {
                        ev.preventDefault();
                        confirmModal.show();
                    });

                    // When user confirms in modal, submit the form
                    var confirmBtn = document.getElementById('confirmCardOrderBtn');
                    confirmBtn.addEventListener('click', function () {
                        // disable button to prevent double submits
                        confirmBtn.disabled = true;
                        form.submit();
                    });
                });
            </script>
        {% endif %}
        <div class="card-footer-info">
            <small><i class="bi bi-truck"></i>Free delivery within 5-7 business days</small>
        </div>
    </div>
</div>
