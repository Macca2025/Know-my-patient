# Production Deployment Guide

## ‚ö†Ô∏è CRITICAL: Files Required in Production

### ‚úÖ **MUST INCLUDE (Essential):**

#### `composer.json` - **REQUIRED**
**Why:** 
- Defines ALL production dependencies (Slim, PHPMailer, Sentry, Twig, etc.)
- Contains autoload configuration (PSR-4: `App\\` ‚Üí `src/`)
- Without it, `composer install` won't work
- Application will crash without autoloading

**Contains:**
```json
{
  "require": {           // Production packages
    "slim/slim": "^4.10",
    "phpmailer/phpmailer": "^6.10",
    "sentry/sentry": "^4.16",
    ...
  },
  "autoload": {          // CRITICAL for class loading
    "psr-4": {
      "App\\": "src/"   // Maps namespace to directory
    }
  }
}
```

#### `composer.lock` - **REQUIRED**
**Why:**
- Locks exact versions of all dependencies
- Ensures production matches development
- Reproducible builds
- Security - prevents unexpected updates

#### Other Essential Files:
```
‚úÖ public/            - Web root with index.php
‚úÖ src/               - Application source code
‚úÖ templates/         - Twig templates
‚úÖ app/               - Application configuration
‚úÖ var/               - Cache and temporary files
‚úÖ logs/              - Application logs
‚úÖ vendor/            - Composer dependencies (generated)
‚úÖ .env.example       - Environment template
```

---

## üö´ Exclude from Production

### Development Tools (NOT needed):
```
‚ùå config/            - PHPUnit, PHPStan, PHPCS configs
‚ùå tests/             - Unit tests
‚ùå docs/              - Documentation
‚ùå .git/              - Git repository
‚ùå .github/           - GitHub workflows
‚ùå database_migrations/  - Migration scripts
‚ùå DEV_TOOLS_GUIDE.md    - Development guide
‚ùå .phpunit.result.cache - Test cache
```

---

## üöÄ Automated Production Build

### Quick Start: Use the Build Script

```bash
# One command to build production-ready package
./scripts/build-production.sh
```

**What it does:**
1. ‚úÖ Creates `build-production/` directory
2. ‚úÖ Copies only production files
3. ‚úÖ Excludes dev tools (config/, tests/, docs/)
4. ‚úÖ Runs `composer install --no-dev --optimize-autoloader`
5. ‚úÖ Sets correct file permissions
6. ‚úÖ Validates critical files exist
7. ‚úÖ Creates .env from .env.example

**Output:**
```
build-production/
‚îú‚îÄ‚îÄ composer.json          ‚úÖ Included
‚îú‚îÄ‚îÄ composer.lock          ‚úÖ Included
‚îú‚îÄ‚îÄ public/                ‚úÖ Included
‚îú‚îÄ‚îÄ src/                   ‚úÖ Included
‚îú‚îÄ‚îÄ vendor/                ‚úÖ Generated by composer
‚îú‚îÄ‚îÄ .env                   ‚úÖ Created (needs config)
‚îî‚îÄ‚îÄ [production files]

Excluded:
‚ùå config/     (dev tools)
‚ùå tests/      (unit tests)
‚ùå docs/       (documentation)
```

---

## üì¶ Manual Deployment Methods

### Method 1: Deploy with Composer Install on Server

```bash
# Step 1: Prepare files locally
rsync -av \
  --exclude='config/' \
  --exclude='tests/' \
  --exclude='docs/' \
  --exclude='.git/' \
  --exclude='vendor/' \
  --exclude='node_modules/' \
  ./ user@server:/var/www/know_my_patient/

# Step 2: On production server
ssh user@server
cd /var/www/know_my_patient

# Step 3: Install ONLY production dependencies
composer install --no-dev --optimize-autoloader

# Step 4: Configure environment
cp .env.example .env
nano .env  # Edit with production values

# Step 5: Set permissions
chmod -R 755 public/
chmod -R 777 var/cache/
chmod -R 777 logs/
```

### Method 2: Pre-built Vendor (Faster)

```bash
# Step 1: Build vendor locally
composer install --no-dev --optimize-autoloader

# Step 2: Deploy everything (including vendor/)
rsync -av \
  --exclude='config/' \
  --exclude='tests/' \
  --exclude='docs/' \
  --exclude='.git/' \
  ./ user@server:/var/www/know_my_patient/

# Step 3: Configure on server
ssh user@server
cd /var/www/know_my_patient
cp .env.example .env
nano .env
```

### Method 3: Git Archive (Clean Export)

```bash
# Create clean archive (uses .gitattributes)
git archive --format=tar --prefix=know_my_patient/ HEAD | gzip > production.tar.gz

# Transfer and extract
scp production.tar.gz user@server:/tmp/
ssh user@server
cd /var/www/
tar -xzf /tmp/production.tar.gz

# Install dependencies
cd know_my_patient/
composer install --no-dev --optimize-autoloader
```

---

## üîß Production Environment Configuration

### Required .env Settings:

```bash
# Application
APP_ENV=production        # CRITICAL: Must be "production"
APP_DEBUG=false           # CRITICAL: Must be false for security

# Database
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=know_my_patient
DB_USERNAME=production_user
DB_PASSWORD=secure_password_here

# Security
APP_KEY=your-32-character-random-key-here

# Email (PHPMailer)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_ENCRYPTION=tls
SMTP_FROM_ADDRESS=noreply@yourapp.com
SMTP_FROM_NAME="Know My Patient"

# Monitoring
SENTRY_DSN=your-sentry-dsn-here

# Paths
BASE_PATH=/var/www/know_my_patient
```

---

## ‚úÖ Post-Deployment Checklist

### 1. Verify Critical Files:
```bash
ls -la composer.json        # Must exist
ls -la composer.lock        # Must exist
ls -la public/index.php     # Must exist
ls -la vendor/autoload.php  # Must exist (from composer install)
```

### 2. Check Permissions:
```bash
chmod -R 755 public/
chmod -R 777 var/cache/
chmod -R 777 logs/
chmod -R 755 uploads/
```

### 3. Verify Environment:
```bash
cat .env | grep APP_ENV    # Should be "production"
cat .env | grep APP_DEBUG  # Should be "false"
```

### 4. Test Application:
```bash
# Check PHP syntax
php -l public/index.php

# Test autoloader
php -r "require 'vendor/autoload.php'; echo 'Autoload OK';"

# Check web server
curl -I http://your-domain.com
```

### 5. Verify OPcache (if installed):
```bash
php -i | grep opcache
# Should show opcache.enable=On
```

---

## üîí Security Recommendations

1. **Never commit .env to git**
   ```bash
   # Already in .gitignore
   .env
   ```

2. **Use environment-specific .env**
   ```bash
   # Development: .env (APP_DEBUG=true)
   # Production: .env (APP_DEBUG=false)
   ```

3. **Exclude dev dependencies**
   ```bash
   composer install --no-dev
   ```

4. **Set correct file permissions**
   ```bash
   # Files: 644
   # Directories: 755
   # Writeable: var/cache/, logs/ = 777
   ```

5. **Use HTTPS only**
   - HTTPS enforcement middleware is already active

---

## üìä Production vs Development Comparison

| Item | Development | Production |
|------|-------------|------------|
| `composer.json` | ‚úÖ Required | ‚úÖ **Required** |
| `composer.lock` | ‚úÖ Required | ‚úÖ **Required** |
| `config/` | ‚úÖ Present | ‚ùå Excluded |
| `tests/` | ‚úÖ Present | ‚ùå Excluded |
| `docs/` | ‚úÖ Present | ‚ùå Excluded |
| `vendor/` | Generated | Generated |
| `APP_DEBUG` | true | **false** |
| `APP_ENV` | development | **production** |
| Dev dependencies | Installed | **Excluded** |

---

## üÜò Troubleshooting

### Error: "Class not found"
**Cause:** Missing `composer.json` or autoload not generated
**Solution:**
```bash
composer dump-autoload --optimize
```

### Error: "vendor/autoload.php not found"
**Cause:** Composer dependencies not installed
**Solution:**
```bash
composer install --no-dev --optimize-autoloader
```

### Error: "Cannot write to cache directory"
**Cause:** Incorrect permissions
**Solution:**
```bash
chmod -R 777 var/cache/
chmod -R 777 logs/
```

### Website shows errors
**Cause:** APP_DEBUG=true in production
**Solution:**
```bash
# In .env file
APP_DEBUG=false
APP_ENV=production
```

---

## üìö Related Documentation

- [Deployment Guide](docs/DEPLOYMENT.md)
- [Environment Configuration](docs/setup/CRON_SETUP_GUIDE.md)
- [Development Tools Guide](DEV_TOOLS_GUIDE.md)
- [Recommendations Status](docs/RECOMMENDATIONS_STATUS.md)

---

## üéØ Quick Reference

**Build production package:**
```bash
./scripts/build-production.sh
```

**Deploy to server:**
```bash
rsync -avz build-production/ user@server:/var/www/app/
```

**On server:**
```bash
cd /var/www/app
cp .env.example .env
nano .env  # Configure
chmod -R 755 public/
chmod -R 777 var/cache/ logs/
```

**Verify:**
```bash
php -l public/index.php
curl -I http://your-domain.com
```

---

*Last Updated: 13 October 2025*
